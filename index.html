<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é™¤å¤•å¤œÂ·ä¸“å±æƒŠå–œ</title>
  <meta name="theme-color" content="#0b0b12" />
  <style>
    :root{
      --bg1:#070711; --bg2:#140b1c;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.12);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --gold: #ffd37a;
      --pink: #ff7bd1;
      --red: #ff3b3b;
      --green: #4cffb1;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh;
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "PingFang SC","Hiragino Sans GB","Microsoft YaHei", Arial;
      background: radial-gradient(1200px 900px at 20% 10%, #1a0d2b 0%, transparent 55%),
                  radial-gradient(1000px 700px at 90% 20%, #3a0f1f 0%, transparent 55%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    canvas#fx{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
    }
    .wrap{
      position:relative; z-index:2;
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 16px 90px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-top:6px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700;
      letter-spacing:.3px;
      user-select:none;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      font-size: 13px;
      color: var(--muted);
      white-space:nowrap;
    }
    .chip b{ color: var(--txt); }
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 880px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .hero{
      padding: 18px 18px 14px;
      position:relative;
    }
    .title{
      font-size: 22px;
      line-height: 1.2;
      margin: 0 0 6px;
      font-weight: 800;
    }
    .sub{
      margin:0;
      color: var(--muted);
      line-height: 1.6;
      font-size: 14px;
    }
    .meta{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top: 12px;
    }
    .meta .pill{
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 13px;
      color: rgba(255,255,255,.85);
      display:flex; align-items:center; gap:8px;
    }
    .meta .dot{
      width:8px; height:8px; border-radius:99px;
      background: var(--pink);
      box-shadow: 0 0 0 4px rgba(255,123,209,.15);
    }

    .actions{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top: 14px;
    }
    button, .btn{
      appearance:none;
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight:700;
      cursor:pointer;
      color:#0b0b12;
      background: linear-gradient(135deg, var(--gold), #ff9bdc);
      box-shadow: 0 16px 40px rgba(255, 155, 220, .18);
      transition: transform .08s ease, filter .12s ease;
      user-select:none;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    button.secondary{
      color: var(--txt);
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 16px 40px rgba(0,0,0,.25);
    }
    button.ghost{
      color: rgba(255,255,255,.86);
      background: transparent;
      border: 1px dashed rgba(255,255,255,.22);
      box-shadow:none;
    }
    button.small{
      padding:10px 12px;
      border-radius: 12px;
      font-size: 13px;
    }
    .panel{
      padding: 14px 16px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .input{
      flex: 1 1 210px;
      display:flex;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      overflow:hidden;
    }
    .input input{
      width:100%;
      background: transparent;
      border:0;
      outline:none;
      color: var(--txt);
      padding: 12px 12px;
      font-size: 14px;
    }
    .input span{
      padding: 12px 12px;
      color: rgba(255,255,255,.55);
      border-left: 1px solid rgba(255,255,255,.10);
      font-size: 13px;
      white-space:nowrap;
    }
    .side{
      padding: 14px;
    }
    .side h3{
      margin: 2px 0 8px;
      font-size: 14px;
      color: rgba(255,255,255,.88);
      letter-spacing:.2px;
    }
    .list{
      display:flex; flex-direction:column; gap:10px;
      margin-top: 10px;
    }
    .task{
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.12);
    }
    .task .top{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      margin-bottom: 6px;
    }
    .task .name{
      font-weight:800;
      font-size: 14px;
      display:flex; gap:10px; align-items:center;
    }
    .badge{
      font-size:12px;
      padding: 6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.80);
      white-space:nowrap;
    }
    .task p{
      margin:0;
      font-size: 13px;
      line-height: 1.6;
      color: rgba(255,255,255,.72);
    }
    .bar{
      height: 10px;
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.12);
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #ff8adf, #ffd37a, #78ffcd);
      border-radius:999px;
      transition: width .28s ease;
    }

    /* modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      z-index: 10;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(720px, 100%);
      background: rgba(15, 12, 25, .92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 30px 90px rgba(0,0,0,.60);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .modal header{
      padding: 14px 16px;
      margin:0;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal header h2{
      margin:0;
      font-size: 16px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .modal .content{
      padding: 16px;
      line-height:1.75;
      color: rgba(255,255,255,.86);
      font-size: 14px;
    }
    .modal .content .hint{
      color: rgba(255,255,255,.68);
      font-size: 13px;
      margin-top:10px;
    }
    .modal .foot{
      padding: 12px 16px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .kbd{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.85);
      font-size: 12px;
      margin: 0 4px;
      white-space:nowrap;
    }

    /*çº¢åŒ…é›¨*/
.money{
  position:fixed;
  top:-40px;
  z-index: 9999;              /* âœ… é«˜äº .wrap(2)ï¼Œä½äº overlay(10) */
  font-size: 22px;
  opacity: .95;
  filter: drop-shadow(0 8px 10px rgba(0,0,0,.35));
  animation: fall linear forwards;
  user-select:none;
  pointer-events:auto;      /* âœ… å…è®¸ç‚¹ */
  touch-action: manipulation; /* âœ… ç§»åŠ¨ç«¯ç‚¹æŒ‰æ›´ç¨³å®š */
}
    @keyframes fall{
      to { transform: translateY(calc(100vh + 80px)) rotate(360deg); opacity: .2; }
    }

    footer{
      margin-top: 14px;
      color: rgba(255,255,255,.50);
      font-size: 12px;
      text-align:center;
    }
    .glow{
      position:absolute; inset:auto -40px -60px auto;
      width: 220px; height: 220px;
      background: radial-gradient(circle at 30% 30%, rgba(255,123,209,.45), transparent 55%),
                  radial-gradient(circle at 60% 60%, rgba(255,211,122,.35), transparent 55%);
      filter: blur(10px);
      opacity:.85;
      pointer-events:none;
    }
  </style>
</head>
<body>
<canvas id="fx"></canvas>
<audio id="bgm" preload="auto" loop playsinline>
  <source src="assets/bgm.mp3" type="audio/mpeg">
</audio>

<div class="wrap">
  <header>
    <div class="brand">
      <span style="font-size:20px">ğŸ†</span>
      <span>é™¤å¤•å¤œÂ·ä¸“å±æƒŠå–œ</span>
    </div>
    <div class="chip" id="clockChip">ç°åœ¨ï¼š<b id="nowStr">--</b></div>
  </header>

  <div class="grid">
    <!-- left -->
    <section class="card">
      <div class="hero">
        <div class="glow"></div>
        <h1 class="title" id="heroTitle">ç»™ <span id="gfNameShow">ä½ æœ€çˆ±çš„å¥¹</span> çš„é™¤å¤•å°å®‡å®™</h1>
        <p class="sub" id="heroSub">
          ä»Šæ™šä¸è®²é“ç†ï¼Œåªè®²åçˆ±ã€‚<br/>
          å…ˆç©ä¸ªå°äº’åŠ¨ï¼šå®Œæˆä»»åŠ¡å°±è§£é”â€œç»ˆææƒŠå–œâ€æŒ‰é’® âœ¨
        </p>

        <div class="meta">
          <div class="pill"><span class="dot"></span><span>çƒŸèŠ±ï¼šç‚¹å±å¹•å¯ç‚¸</span></div>
          <div class="pill"><span class="dot" style="background:#ffd37a; box-shadow:0 0 0 4px rgba(255,211,122,.15)"></span><span>çº¢åŒ…é›¨ï¼šéšæ—¶å¼€</span></div>
          <div class="pill"><span class="dot" style="background:#4cffb1; box-shadow:0 0 0 4px rgba(76,255,177,.15)"></span><span>é—¯å…³æ—¶é•¿ï¼šçº¦ 3â€“5 åˆ†é’Ÿ</span></div>
        </div>

        <div class="actions">
          <button id="btnStart">ğŸ’– å¼€å§‹ä»Šæ™šçš„æƒŠå–œ</button>
          <button class="secondary" id="btnMoney">ğŸ§§ ä¸‹çº¢åŒ…é›¨</button>
          <button class="ghost" id="btnMusic">ğŸµ å¼€å¯å°æ°›å›´</button>
        </div>
      </div>

      <div class="panel">
        <div class="row">
          <div class="input">
            <input id="gfName" placeholder="å®å®" maxlength="10">
            <span>å¥¹çš„æ˜µç§°</span>
          </div>
          <div class="input">
            <input id="yourName" placeholder="å¤§ç¬¨çŒª" maxlength="10">
            <span>ä½ çš„æ˜µç§°</span>
          </div>
          <button class="secondary small" id="btnApply">âœ… åº”ç”¨</button>
        </div>

        <div style="margin-top:10px; color:rgba(255,255,255,.65); font-size:13px; line-height:1.6">
          å°æç¤ºï¼šå¦‚æœåœ¨æ‰‹æœºä¸Šæ‰“å¼€ï¼Œå»ºè®®<strong>å…¨å±æµè§ˆ</strong>ï¼Œæ›´æ²‰æµ¸ã€‚<br/>
        </div>
      </div>
    </section>

    <!-- right -->
    <aside class="card side">
      <h3>ğŸ¯ ä»Šæ™šä»»åŠ¡è¿›åº¦</h3>
      <div class="bar" aria-label="progress"><i id="barFill"></i></div>

      <div class="list" id="taskList"></div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="secondary" id="btnHint">ğŸ’¡ ç»™æˆ‘æç¤º</button>
        <button id="btnFinal" disabled title="å®Œæˆä»»åŠ¡åè§£é”">ğŸ ç»ˆææƒŠå–œï¼ˆé”å®šï¼‰</button>
      </div>

      <div style="margin-top:12px; color:rgba(255,255,255,.65); font-size:13px; line-height:1.65">
        ç©æ³•ï¼šæŒ‰ä»»åŠ¡é¡ºåºå®Œæˆå³å¯ã€‚æ¯å®Œæˆä¸€ä¸ªï¼Œä¼šæœ‰çƒŸèŠ±åº†ç¥ã€‚<br/>
        <span style="color:rgba(255,255,255,.85)">éšè—å½©è›‹ï¼š</span>æŒ‰ <span class="kbd">H</span> ä¼šå‡ºç°â€œå®³ç¾æ¨¡å¼â€ğŸ˜³
      </div>
    </aside>
  </div>

  <footer>
    Made with â¤ï¸ for your New Year's Eve.ï¼ˆå¯è‡ªç”±ä¿®æ”¹å†…å®¹ï¼‰
  </footer>
</div>

<!-- modal -->
<div class="overlay" id="overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <h2 id="modalTitle">æ ‡é¢˜</h2>
      <button class="secondary small" id="btnClose">âœ–</button>
    </header>
    <div class="content" id="modalContent"></div>
    <div class="foot" id="modalFoot"></div>
  </div>
</div>

<script>
/** ========= ä½ å¯ä»¥æ”¹è¿™é‡Œï¼šå®šåˆ¶æ–‡æœ¬ ========= **/
const DEFAULT_GF_NAME = "å®å®";
const DEFAULT_YOUR_NAME = "å¤§ç¬¨çŒª";

const QUESTIONS = [
  {
    id: "q1",
    title: "ç¬¬ä¸€å…³ï¼šä¸“å±ç§°å‘¼",
    desc: "è¾“å…¥ä½ ç»™å¥¹çš„æ˜µç§° & ä½ è‡ªå·±çš„æ˜µç§°ï¼Œç‚¹å‡»ã€åº”ç”¨ã€‘ã€‚",
    type: "applyNames"
  },
  {
    id: "q2",
    title: "ç¬¬äºŒå…³ï¼šä¸‰é€‰ä¸€ï¼ˆå¿…é€‰ï¼‰",
    desc: "é€‰ä¸€ä¸ªä½ ä»Šæ™šè¦åšçš„äº‹ã€‚",
    type: "choice",
    options: [
      { text: "çœ‹ä¸€åœºçƒŸèŠ±", value: "hug" },
      { text: "å¤¸å®è´10 å¥ï¼ˆç›¸å½“çœŸè¯šï¼‰", value: "praise" },
      { text: "ä¸€èµ·çœ‹æ˜¥æ™š", value: "listen" }
    ]
  },
  {
    id: "q3",
    title: "ç¬¬ä¸‰å…³ï¼šå°é»˜å¥‘",
    desc: "å›ç­”ä¸€ä¸ªåªæœ‰ä½ ä»¬çŸ¥é“çš„å°é—®é¢˜ï¼ˆç­”å¯¹æ‰èƒ½è¿‡ï¼‰ã€‚",
    type: "code",
    prompt: "æˆ‘ä»¬ç»å¸¸ä¸€èµ·åšçš„â€˜å¾ˆæ™®é€šä½†å¾ˆå¹¸ç¦â€™çš„å°äº‹æ˜¯ï¼Ÿ",
    acceptKeywords: ["æ•£æ­¥","åƒé¥­","é€›è¡—","é€›è¶…å¸‚","å–é…’"]
  },
  {
    id: "q4",
    title: "ç¬¬å››å…³ï¼šå†™ä¸‹ä¸€ä¸ªæ„¿æœ›",
    desc: "å†™ä¸‹ä½ ä»Šå¹´æœ€æƒ³å®ç°çš„ä¸€ä¸ªæ„¿æœ›ï¼ˆè®¤çœŸå†™ï¼‰ï¼Œæäº¤åè¿‡å…³ã€‚",
    type: "wish",
    placeholder: "æ¯”å¦‚ï¼šæƒ³å’Œå¤§ç¬¨çŒªä¸€èµ·å»çœ‹æµ· / æƒ³æ¯å¤©éƒ½å¼€å¿ƒ / æƒ³å®ç°ä¸€ä¸ªå°ç›®æ ‡â€¦",
    minLen: 4
  },
  {
    id: "q5",
    title: "ç¬¬äº”å…³ï¼šæ‹†çº¢åŒ…ï¼ˆé•¿ä¸€ç‚¹ï¼‰",
    desc: "åœ¨çº¢åŒ…é›¨é‡Œç‚¹åˆ° 10 ä¸ªçº¢åŒ…ğŸ§§ï¼ˆç‚¹ä¸­ä¼š+1ï¼‰ã€‚",
    type: "tapMoney",
    need: 10
  }
];

const GIFT_POOL = [
  "ä¸€ä»½åŒ–å¦†å“ï¼ˆä½ æŒ‘æˆ‘å–œæ¬¢çš„ï¼ï¼‰",
  "ä¸€æ¬¡å¤§é¤ï¼ˆä»Šå¤©æˆ‘è¯´äº†ç®—ï¼‰",
  "ä¸€æ¬¡æ—…æ¸¸ï¼ˆæŒ‘ä¸ªåœ°æ–¹æˆ‘ä»¬å°±å‡ºå‘ï¼‰",
  "ä¸€æ¬¡æŒ‰æ‘©ï¼ˆæ”¾æ¾å®‰æ’ä¸Šï¼‰"
];

function finalLetter(gf, you){
  return `
  <div style="font-size:15px">
    <div style="font-weight:900; font-size:16px; margin-bottom:8px">ç»™ ${gf}ï¼š</div>
    <div style="color:rgba(255,255,255,.88)">
      ä»Šæ™šæ˜¯é™¤å¤•å¤œï¼Œæˆ‘æƒ³æŠŠâ€œæ–°çš„ä¸€å¹´â€æå‰äº¤åˆ°ä½ æ‰‹é‡Œã€‚<br/>
      æˆ‘æƒ³å’Œä½ åœ¨ä¸€èµ·ä¸€å¹´åˆä¸€å¹´ï¼Œä¹Ÿæ„Ÿè°¢å®å®èƒ½ä¸€ç›´åœ¨æˆ‘èº«è¾¹ã€‚<br/><br/>
      ä½ å¯ä»¥ä»»æ€§ã€å¯ä»¥é—¹ã€å¯ä»¥ä¸å¼€å¿ƒâ€”â€”æˆ‘éƒ½æ¥ä½ã€‚<br/>
      ä½ å¯ä»¥æœŸå¾…ã€å¯ä»¥å‘å…‰ã€å¯ä»¥åšä½ è‡ªå·±â€”â€”æˆ‘ä¼šä¸€ç›´åœ¨ã€‚<br/><br/>
      æœŸå¾…ä»Šå¹´å’Œä½ ä¸€èµ·å»çœ‹æµ·<br/><br/>
      æ–°å¹´æ„¿æœ›å¾ˆç®€å•ï¼š<br/>
      <b style="color:#ffd37a">æ¯å¤©éƒ½å¤šçˆ±ä½ ä¸€ç‚¹ç‚¹ã€‚</b><br/><br/>
      â€”â€”${you}
    </div>
    <div class="hint"></div>
  </div>
  `;
}
/** ========= å®šåˆ¶åŒºç»“æŸ ========= **/

/** ========= çŠ¶æ€ ========= **/
const state = {
  gf: DEFAULT_GF_NAME,
  you: DEFAULT_YOUR_NAME,
  done: new Set(),
  choice: null,
  wishText: "",
  fireworksCount: 0, // ä¿ç•™ï¼šç‚¹çƒŸèŠ±ä¸æŠ¥é”™
  moneyTapped: 0,
  moneyRaining: false,
  shyMode: false,
  audioOn: false,
  gift: null,          // æŠ½åˆ°/é€‰åˆ°çš„ç¤¼ç‰©
  giftMode: null       // "draw" | "pick" | "custom"
};

const els = {
  gfName: document.querySelector("#gfName"),
  yourName: document.querySelector("#yourName"),
  gfNameShow: document.querySelector("#gfNameShow"),
  heroTitle: document.querySelector("#heroTitle"),
  heroSub: document.querySelector("#heroSub"),
  taskList: document.querySelector("#taskList"),
  barFill: document.querySelector("#barFill"),
  btnFinal: document.querySelector("#btnFinal"),
  btnApply: document.querySelector("#btnApply"),
  btnStart: document.querySelector("#btnStart"),
  btnMoney: document.querySelector("#btnMoney"),
  btnMusic: document.querySelector("#btnMusic"),
  btnHint: document.querySelector("#btnHint"),
  nowStr: document.querySelector("#nowStr"),
  overlay: document.querySelector("#overlay"),
  modalTitle: document.querySelector("#modalTitle"),
  modalContent: document.querySelector("#modalContent"),
  modalFoot: document.querySelector("#modalFoot"),
  btnClose: document.querySelector("#btnClose"),
};

/** ========= å°å·¥å…· ========= **/
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function pct(){ return Math.round((state.done.size / QUESTIONS.length) * 100); }

function updateProgress(){
  els.barFill.style.width = pct() + "%";
  const allDone = state.done.size === QUESTIONS.length;
  els.btnFinal.disabled = !allDone;
  els.btnFinal.title = allDone ? "ç‚¹æˆ‘ï¼" : "å®Œæˆä»»åŠ¡åè§£é”";
}

function confettiBurst(x,y){
  for(let i=0;i<30;i++){
    const s = document.createElement("div");
    s.style.position="fixed";
    s.style.left = (x + (Math.random()*12-6)) + "px";
    s.style.top = (y + (Math.random()*12-6)) + "px";
    s.style.width = (6+Math.random()*6) + "px";
    s.style.height = (6+Math.random()*10) + "px";
    s.style.borderRadius = "6px";
    s.style.background = ["#ffd37a","#ff7bd1","#4cffb1","#ff3b3b","#8ad1ff"][Math.floor(Math.random()*5)];
    s.style.zIndex = 9;
    s.style.pointerEvents="none";
    s.style.transform = `rotate(${Math.random()*180}deg)`;
    document.body.appendChild(s);
    const dx = (Math.random()*2-1) * 220;
    const dy = (Math.random()*2-1) * 220 - 120;
    s.animate([
      { transform: s.style.transform + " translate(0,0)", opacity: 1 },
      { transform: s.style.transform + ` translate(${dx}px,${dy}px)`, opacity: 0 }
    ], { duration: 900 + Math.random()*700, easing:"cubic-bezier(.2,.8,.2,1)" })
    .onfinish = ()=> s.remove();
  }
}

function showModal(title, html, buttons=[]){
  els.modalTitle.textContent = title;
  els.modalContent.innerHTML = html;
  els.modalFoot.innerHTML = "";
  buttons.forEach(b=>{
    const btn = document.createElement("button");
    btn.textContent = b.text;
    btn.className = b.className || "";
    btn.onclick = ()=>{ if(b.onClick) b.onClick(); };
    els.modalFoot.appendChild(btn);
  });
  els.overlay.classList.add("show");
}

function closeModal(){ els.overlay.classList.remove("show"); }
els.btnClose.onclick = closeModal;
els.overlay.addEventListener("click",(e)=>{ if(e.target===els.overlay) closeModal(); });

/** ========= é˜² XSS ç®€æ˜“ ========= **/
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/** ========= ä»»åŠ¡æ¸²æŸ“ ========= **/
function renderTasks(){
  els.taskList.innerHTML = "";
  QUESTIONS.forEach((q)=>{
    const div = document.createElement("div");
    div.className = "task";
    const done = state.done.has(q.id);
    div.innerHTML = `
      <div class="top">
        <div class="name">${done ? "âœ…" : "â¬œ"} <span>${q.title}</span></div>
        <span class="badge">${done ? "å·²å®Œæˆ" : "æœªå®Œæˆ"}</span>
      </div>
      <p>${q.desc}</p>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="${done ? "secondary" : ""} small" data-act="open" data-id="${q.id}">
          ${done ? "å†çœ‹ä¸€æ¬¡" : "å»å®Œæˆ"}
        </button>
      </div>
    `;
    els.taskList.appendChild(div);
  });

  els.taskList.querySelectorAll("button[data-act='open']").forEach(btn=>{
    btn.addEventListener("click", ()=> openTask(btn.dataset.id));
  });

  updateProgress();
}

/** ========= openTaskï¼šå·²ä¿®å¤çš„å¹²å‡€ç‰ˆ ========= **/
function openTask(id){
  const q = QUESTIONS.find(x=>x.id===id);
  if(!q) return;

  if(q.type==="applyNames"){
    showModal(q.title, `
      <div>åœ¨ä¸»é¡µè¾“å…¥æ˜µç§°åï¼Œç‚¹å‡» <b>âœ… åº”ç”¨</b> å°±èƒ½è¿‡å…³ã€‚</div>
      <div class="hint">æƒ³æ›´ç”œï¼šæ˜µç§°å¯ä»¥å†™â€œä½ å¯¹å¥¹çš„ç‹¬å®¶ç§°å‘¼â€ã€‚</div>
    `, [
      {text:"æˆ‘å»åº”ç”¨", className:"secondary", onClick: closeModal}
    ]);
    return;
  }

  if(q.type==="choice"){
    const opts = q.options.map(o=>{
      const active = state.choice===o.value;
      return `
        <button class="${active ? "" : "secondary"}" style="width:100%; justify-content:flex-start"
          data-choice="${o.value}">
          ${active ? "âœ… " : ""}${o.text}
        </button>
      `;
    }).join("");

    showModal(q.title, `
      <div style="margin-bottom:10px">${q.desc}</div>
      <div style="display:grid; gap:10px">${opts}</div>
      <div class="hint">å¥¹ç‚¹äº†å°±ç®—â€œç›–ç« â€ã€‚ä½ è¦è¯´åˆ°åšåˆ°å“¦ï½</div>
    `, [
      {text:"å®Œæˆ", onClick: ()=>{
        if(!state.choice){
          showModal("è¿˜å·®ä¸€æ­¥", "å…ˆé€‰ä¸€ä¸ªé€‰é¡¹å˜›ï½", [
            {text:"å¥½", className:"secondary", onClick: closeModal}
          ]);
          return;
        }
        markDone(q.id);
        closeModal();
      }},
      {text:"å…³é—­", className:"secondary", onClick: closeModal}
    ]);

    els.modalContent.querySelectorAll("button[data-choice]").forEach(b=>{
      b.onclick = ()=>{
        state.choice = b.dataset.choice;
        openTask(q.id);
      };
    });
    return;
  }

  if(q.type==="code"){
    showModal(q.title, `
      <div style="margin-bottom:10px">${q.prompt}</div>
      <div class="input" style="margin:10px 0;">
        <input id="ansInput" placeholder="è¾“å…¥å…³é”®è¯ï¼ˆæ¯”å¦‚ï¼šæ•£æ­¥/å¥¶èŒ¶/çœ‹ç”µå½±ï¼‰" maxlength="30" />
        <span>ç­”æ¡ˆ</span>
      </div>
      <div class="hint"></div>
    `, [
      {text:"æäº¤ç­”æ¡ˆ", onClick: ()=>{
        const v = (document.querySelector("#ansInput")?.value || "").trim();
        const ok = q.acceptKeywords.some(k=> v.includes(k));
        if(ok){
          markDone(q.id);
          fireworkAt(window.innerWidth*0.5, window.innerHeight*0.3, true);
          showModal("ç­”å¯¹å•¦ï¼", `å¥½çš„ï¼æˆ‘ç¡®è®¤äº†ï¼šä½ ä»¬çš„é»˜å¥‘æ˜¯ <b>${escapeHtml(v || "ï¼ˆç§˜å¯†ï¼‰")}</b> ğŸ’`, [
            {text:"ç»§ç»­é—¯å…³", onClick: closeModal}
          ]);
        }else{
          showModal("å·®ä¸€ç‚¹ç‚¹", "è¿™ä¸ªä¸å¤ªåƒâ€¦å†æƒ³æƒ³ä½ ä»¬æœ€å¹¸ç¦çš„â€˜å°äº‹â€™å…³é”®è¯ï¼Ÿ", [
            {text:"å†è¯•ä¸€æ¬¡", className:"secondary", onClick: ()=> openTask(q.id)},
            {text:"æˆ‘çœŸçš„æƒ³ä¸èµ·æ¥", onClick: ()=>{
              showModal("å¯çˆ±æƒ©ç½šğŸ˜¼", `
                é‚£å°±è¿™æ ·ï¼šä½ è¦å¯¹å¥¹è¯´ä¸€å¥â€”â€”<br/>
                <b style="color:#ffd37a">â€œæˆ‘å¯èƒ½è®°æ€§ä¸å¥½ï¼Œä½†æˆ‘çˆ±ä½ è¿™ä»¶äº‹ç»å¯¹ä¸ä¼šå¿˜ã€‚â€</b><br/><br/>
                è¯´å®Œç‚¹ä¸‹é¢æŒ‰é’®å°±ç®—è¿‡å…³ã€‚
              `, [
                {text:"æˆ‘è¯´äº†ï¼è¿‡å…³", onClick: ()=>{
                  markDone(q.id);
                  closeModal();
                }},
                {text:"æˆ‘å†æƒ³æƒ³", className:"secondary", onClick: ()=> openTask(q.id)}
              ]);
            }}
          ]);
        }
      }},
      {text:"å…³é—­", className:"secondary", onClick: closeModal}
    ]);
    return;
  }

  if(q.type==="wish"){
    showModal(q.title, `
      <div style="margin-bottom:10px">${q.desc}</div>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
        <textarea id="wishInput" rows="5"
          style="width:100%; resize:none; padding:12px; border-radius:14px;
          border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.22);
          color:rgba(255,255,255,.92); outline:none; font-size:14px; line-height:1.6"
          placeholder="${q.placeholder || ""}">${state.wishText || ""}</textarea>
        <div class="hint">å†™å®Œæäº¤å°±è¿‡å…³ã€‚æ„¿æœ›ä¼šåœ¨ç»ˆææƒŠå–œé‡Œå±•ç¤ºâœ¨</div>
      </div>
    `, [
      {text:"æäº¤æ„¿æœ›", onClick: ()=>{
        const v = (document.querySelector("#wishInput")?.value || "").trim();
        const minLen = q.minLen || 1;
        if(v.length < minLen){
          showModal("å†å†™ä¸€ç‚¹ç‚¹ï½", `æ„¿æœ›è‡³å°‘å†™ <b>${minLen}</b> ä¸ªå­—ï¼Œè®©å¤§ç¬¨çŒªæ›´å¥½å®ç°å®ƒã€‚`, [
            {text:"æˆ‘ç»§ç»­å†™", className:"secondary", onClick: ()=> openTask(q.id)}
          ]);
          return;
        }
        state.wishText = v;
        markDone(q.id);
        fireworkAt(window.innerWidth*0.5, window.innerHeight*0.28, true);
        showModal("æ„¿æœ›å·²å°å­˜âœ¨", `
          <div style="line-height:1.75">
            æˆ‘è®°ä½å•¦ï¼š<br/>
            <div style="margin-top:10px; padding:12px; border-radius:16px;
              background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12)">
              ${escapeHtml(v)}
            </div>
            <div class="hint">å¤§ç¬¨çŒªï¼šæ”¶åˆ°ä»»åŠ¡ï¼ˆè®¤çœŸæ‰§è¡Œç‰ˆï¼‰ğŸ·</div>
          </div>
        `, [{text:"ç»§ç»­é—¯å…³", onClick: closeModal}]);
      }},
      {text:"å…³é—­", className:"secondary", onClick: closeModal}
    ]);
    return;
  }

  if(q.type==="tapMoney"){
    showModal(q.title, `
      <div style="margin-bottom:10px">${q.desc}</div>
      <div>å·²ç‚¹åˆ°ï¼š<b id="mCount">${state.moneyTapped}</b> / ${q.need}</div>
      <div class="hint">ç‚¹å³ä¾§çš„ã€ğŸ§§ ä¸‹çº¢åŒ…é›¨ã€‘å¼€å§‹ï¼Œ<b>ç‚¹ä¸­çº¢åŒ…</b>ä¼š+1ã€‚</div>
    `, [
      {text:"å¼€å§‹çº¢åŒ…é›¨", onClick: ()=>{
        startMoneyRain(false);
        closeModal();
      }},
      {text:"å…³é—­", className:"secondary", onClick: closeModal}
    ]);
    return;
  }

  showModal("æç¤º", "è¿™ä¸€å…³æš‚æ—¶æ²¡æœ‰ç»‘å®šäº¤äº’ï¼ˆæ£€æŸ¥ type æ˜¯å¦æ‹¼å†™ä¸€è‡´ï¼‰ã€‚", [
    {text:"çŸ¥é“å•¦", className:"secondary", onClick: closeModal}
  ]);
}

/** ========= å®Œæˆå…³å¡ ========= **/
function markDone(id){
  if(!state.done.has(id)){
    state.done.add(id);
    renderTasks();
    fireworkAt(window.innerWidth*0.6, window.innerHeight*0.25, true);
    confettiBurst(window.innerWidth*0.65, window.innerHeight*0.30);
    if(navigator.vibrate) navigator.vibrate([40,20,40]);
  } else {
    renderTasks();
  }
}

/** ========= æ˜µç§°åº”ç”¨ ========= **/
function applyNames(){
  const gf = els.gfName.value.trim().slice(0,10) || DEFAULT_GF_NAME;
  const you = els.yourName.value.trim().slice(0,10) || DEFAULT_YOUR_NAME;
  state.gf = gf; state.you = you;
  els.gfNameShow.textContent = gf;

  els.heroTitle.innerHTML = `ç»™ <span id="gfNameShow">${escapeHtml(gf)}</span> çš„é™¤å¤•å°å®‡å®™`;
  els.heroSub.innerHTML = `ä»Šæ™šä¸è®²é“ç†ï¼Œåªè®²åçˆ±ã€‚<br/>${escapeHtml(you)} å·²ç»æŠŠâ€œæ–°çš„ä¸€å¹´â€æ‰“åŒ…æˆæƒŠå–œç»™ä½ å•¦ âœ¨`;

  markDone("q1");
}

/** ========= æç¤ºæŒ‰é’® ========= **/
els.btnHint.onclick = ()=>{
  const next = QUESTIONS.find(q=> !state.done.has(q.id));
  if(!next){
    showModal("æç¤º", "ä½ å·²ç»å…¨éƒ¨å®Œæˆå•¦ï½ç›´æ¥ç‚¹ç»ˆææƒŠå–œï¼", [
      {text:"å»ç»ˆææƒŠå–œ", onClick: ()=>{ closeModal(); els.btnFinal.click(); }},
      {text:"å…³é—­", className:"secondary", onClick: closeModal}
    ]);
    return;
  }
  let msg = "";
  if(next.id==="q1") msg = "å…ˆè¾“å…¥æ˜µç§°ï¼Œç„¶åç‚¹ã€åº”ç”¨ã€‘ã€‚";
  if(next.id==="q2") msg = "è®©å¥¹é€‰ä¸€ä¸ªâ€œä½ ä»Šæ™šè¦åšåˆ°çš„äº‹â€ã€‚";
  if(next.id==="q3") msg = "å†™ä½ ä»¬æœ€å¹¸ç¦çš„ä¸€ä»¶å°äº‹çš„å…³é”®è¯ï¼ˆå¯ç”¨æ•£æ­¥/åƒé¥­/é€›è¡—ç­‰ï¼‰ã€‚";
  if(next.id==="q4") msg = "å†™ä¸‹ä¸€ä¸ªæ„¿æœ›ï¼Œæäº¤å°±è¿‡å…³ã€‚";
  if(next.id==="q5") msg = "ç‚¹ã€ä¸‹çº¢åŒ…é›¨ã€‘ï¼Œå†ç‚¹å±å¹•ä¸Šæ‰è½çš„çº¢åŒ…ã€‚";
  showModal("ğŸ’¡ æç¤º", msg, [{text:"çŸ¥é“å•¦", className:"secondary", onClick: closeModal}]);
};

/** ========= ç»ˆææƒŠå–œ ========= **/
els.btnFinal.onclick = ()=>{
  const html = finalLetter(state.gf, state.you) + `
    <div style="margin-top:14px; padding:12px; border-radius:16px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12)">
      <div style="font-weight:900; margin-bottom:6px; color:#ffd37a">âœ¨ å®å®çš„æ„¿æœ›</div>
      <div style="color:rgba(255,255,255,.82); font-size:14px; line-height:1.75">
        ${state.wishText ? escapeHtml(state.wishText) : "ï¼ˆä½ è¿˜æ²¡å†™æ„¿æœ›å“¦ï½å›å»å®Œæˆç¬¬å››å…³ï¼‰"}
      </div>
    </div>

    <div style="margin-top:14px; padding:12px; border-radius:16px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12)">
      <div style="font-weight:900; margin-bottom:6px; color:#ffd37a">ğŸ ç»ˆæå¤§å¥–ï¼šç¤¼ç‰©æŠ½å¥–/è‡ªé€‰</div>
      <div style="color:rgba(255,255,255,.78); font-size:13px; line-height:1.7">
        å®å®å¯ä»¥éšæœºæŠ½ï¼Œä¹Ÿå¯ä»¥è‡ªå·±é€‰ï¼Œè¿˜å¯ä»¥ç›´æ¥è‡ªå®šä¹‰ã€‚<br/>
        <b style="color:rgba(255,255,255,.9)">å¤§ç¬¨çŒªæ‰¿è¯ºï¼š</b>é€‰äº†å°±å…‘ç°ã€‚
      </div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
        <button id="btnGiftCenter">å»æŠ½å¥– / è‡ªé€‰</button>
        <button class="secondary" id="btnMegaFx">ç›´æ¥è§¦å‘è¶…çº§çƒŸèŠ±</button>
      </div>
      <div style="margin-top:10px; color:rgba(255,255,255,.70); font-size:13px">
        å½“å‰ç¤¼ç‰©ï¼š<b style="color:#ffd37a">${state.gift ? escapeHtml(state.gift) : "æœªç¡®å®š"}</b>
      </div>
    </div>
  `;

  showModal("ğŸ ç»ˆææƒŠå–œè§£é”", html, [
    {text:"âœ¨ ç‚¹æˆ‘è§¦å‘è¶…çº§æƒŠå–œ", onClick: ()=>{ megaSurprise(); }},
    {text:"å…³é—­", className:"secondary", onClick: closeModal}
  ]);

  setTimeout(()=>{
    const a = document.querySelector("#btnGiftCenter");
    const b = document.querySelector("#btnMegaFx");
    if(a) a.onclick = ()=> openGiftCenter();
    if(b) b.onclick = ()=> { closeModal(); megaSurprise(); };
  }, 0);
}; // âœ… å…³é”®ï¼šå¿…é¡»ç»“æŸ onclick

function megaSurprise(){
  closeModal();

  let t = 0;
  const iv = setInterval(()=>{
    const x = Math.random()*window.innerWidth;
    const y = Math.random()*window.innerHeight*0.55;
    fireworkAt(x,y,true);
    t++;
    if(t>18){ clearInterval(iv); }
  }, 120);

  startMoneyRain(true);

  const lines = [
    `${state.gf}ï¼Œæ–°å¹´å¿«ä¹ï¼`,
    `æˆ‘ä¼šä¸€ç›´åçˆ±ä½ ã€‚`,
    `ä½ çš„æƒ…ç»ªæˆ‘è´Ÿè´£æ¥ä½ã€‚`,
    `ä½ çš„å¿«ä¹æˆ‘è´Ÿè´£åŠ å€ã€‚`,
    `ä»Šæ™šæƒ³å¯¹ä½ è¯´ï¼šæˆ‘çˆ±ä½ æˆ‘æƒ³ä½ ã€‚`
  ];
  let i=0;
  const say = ()=>{
    if(i>=lines.length) return;
    toast(lines[i++]);
    setTimeout(say, 850);
  };
  say();
}

/** ========= toast ========= **/
function toast(text){
  const d = document.createElement("div");
  d.textContent = text;
  d.style.position="fixed";
  d.style.left="50%";
  d.style.bottom="24px";
  d.style.transform="translateX(-50%)";
  d.style.background="rgba(0,0,0,.55)";
  d.style.border="1px solid rgba(255,255,255,.18)";
  d.style.color="rgba(255,255,255,.92)";
  d.style.padding="12px 14px";
  d.style.borderRadius="16px";
  d.style.zIndex="12";
  d.style.boxShadow="0 22px 70px rgba(0,0,0,.55)";
  d.style.backdropFilter="blur(10px)";
  document.body.appendChild(d);
  d.animate([{opacity:0, transform:"translateX(-50%) translateY(10px)"},
             {opacity:1, transform:"translateX(-50%) translateY(0)"}],
             {duration:180, easing:"ease-out"});
  setTimeout(()=>{
    d.animate([{opacity:1},{opacity:0}], {duration:240, easing:"ease-in"}).onfinish=()=>d.remove();
  }, 1200);
}

/************ ğŸ ç¤¼ç‰©æŠ½å¥–ä¸­å¿ƒï¼šæ”¾åœ¨ toast() ä¸‹æ–¹ ************/
function pickRandomGift(){
  return GIFT_POOL[Math.floor(Math.random() * GIFT_POOL.length)];
}

function megaFireworks(n){
  let t = 0;
  const iv = setInterval(()=>{
    try{
      fireworkAt(Math.random()*window.innerWidth, Math.random()*window.innerHeight*0.55, true);
    }catch(e){}
    t++;
    if(t>=n) clearInterval(iv);
  }, 140);
}

function showGiftResult(mode, giftText){
  state.giftMode = mode;   // "draw" | "pick" | "custom"
  state.gift = giftText;

  toast("ğŸ ç¤¼ç‰©å·²ç¡®å®šï¼");
  try{
    fireworkAt(window.innerWidth*0.5, window.innerHeight*0.22, true);
    confettiBurst(window.innerWidth*0.52, window.innerHeight*0.26);
  }catch(e){}

  showModal("ğŸ ç¤¼ç‰©ç¡®å®šå•¦", `
    <div style="line-height:1.75">
      <div style="color:rgba(255,255,255,.85)">å®å®çš„æœ€ç»ˆé€‰æ‹©æ˜¯ï¼š</div>
      <div style="margin-top:10px; padding:12px; border-radius:16px;
        background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
        font-weight:900; color:#ffd37a">
        ${escapeHtml(giftText)}
      </div>
      <div class="hint">å¤§ç¬¨çŒªæç¤ºï¼šè¿™ä¸ªç¤¼ç‰©è¦å…‘ç°ï¼Œä¸è®¸èµ–è´¦ğŸ·</div>
    </div>
  `, [
    {text:"å†æ”¾ç‚¹çƒŸèŠ±", onClick: ()=>{ closeModal(); megaFireworks(10); }},
    {text:"å…³é—­", className:"secondary", onClick: closeModal}
  ]);
}

function openGiftCenter(){
  const listHtml = GIFT_POOL.map(g => `
    <button class="secondary" style="width:100%; justify-content:flex-start; text-align:left"
      data-pick="${escapeHtml(g)}">ğŸ ${escapeHtml(g)}</button>
  `).join("");

  showModal("ğŸ ç¤¼ç‰©æŠ½å¥–ä¸­å¿ƒ", `
    <div style="line-height:1.75">
      <div style="color:rgba(255,255,255,.85)">
        å®å®å¯ä»¥éšæœºæŠ½ï¼Œä¹Ÿå¯ä»¥è‡ªå·±é€‰ï¼Œè¿˜å¯ä»¥ç›´æ¥è‡ªå®šä¹‰ï½
      </div>

      <div style="margin-top:12px; display:grid; gap:10px">
        <button id="btnDrawOnce">ğŸ² æŠ½ä¸€æ¬¡ï¼ˆéšæœºï¼‰</button>
        <button class="secondary" id="btnPickOne">ğŸ§¾ æˆ‘è‡ªå·±é€‰ï¼ˆä¸éšæœºï¼‰</button>
        <button class="ghost" id="btnCustom">âœï¸ ä¸æŠ½å¥–ï¼Œæˆ‘è¦è‡ªå®šä¹‰</button>
      </div>

      <div id="pickArea" style="display:none; margin-top:12px; display:grid; gap:10px">
        ${listHtml}
      </div>

      <div id="customArea" style="display:none; margin-top:12px">
        <div class="input" style="margin:10px 0;">
          <input id="customGift" placeholder="å†™ä¸€ä¸ªä½ æƒ³è¦çš„ç¤¼ç‰©/çº¦å®šï¼ˆæ¯”å¦‚ï¼šæ–°å£çº¢/çœ‹æ¼”å”±ä¼š/å»æµ·è¾¹ï¼‰" maxlength="40" />
          <span>è‡ªå®šä¹‰</span>
        </div>
        <div class="hint">å†™å®Œç‚¹â€œç¡®å®šâ€å°±é”å®šï¼ˆå¤§ç¬¨çŒªæ‰§è¡Œï¼‰</div>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
          <button class="secondary" id="btnCustomOK">ç¡®å®š</button>
        </div>
      </div>

      <div style="margin-top:12px; color:rgba(255,255,255,.72); font-size:13px">
        å½“å‰ç¤¼ç‰©ï¼š<b style="color:#ffd37a">${state.gift ? escapeHtml(state.gift) : "æœªç¡®å®š"}</b>
      </div>
    </div>
  `, [
    {text:"å…³é—­", className:"secondary", onClick: closeModal}
  ]);

  const btnDraw = document.querySelector("#btnDrawOnce");
  if(btnDraw){
    btnDraw.onclick = ()=>{
      let spins = 0;
      const maxSpins = 10;
      const roll = setInterval(()=>{
        const g = pickRandomGift();
        toast("ğŸ² " + g);
        spins++;
        if(spins >= maxSpins){
          clearInterval(roll);
          const finalG = pickRandomGift();
          showGiftResult("draw", finalG);
        }
      }, 160);
    };
  }

  const btnPick = document.querySelector("#btnPickOne");
  if(btnPick){
    btnPick.onclick = ()=>{
      const pickArea = document.querySelector("#pickArea");
      const customArea = document.querySelector("#customArea");
      if(pickArea) pickArea.style.display = (pickArea.style.display==="none" ? "grid" : "none");
      if(customArea) customArea.style.display = "none";
    };
  }

  const btnCustom = document.querySelector("#btnCustom");
  if(btnCustom){
    btnCustom.onclick = ()=>{
      const pickArea = document.querySelector("#pickArea");
      const customArea = document.querySelector("#customArea");
      if(customArea) customArea.style.display = "block";
      if(pickArea) pickArea.style.display = "none";
      setTimeout(()=> document.querySelector("#customGift")?.focus(), 0);
    };
  }

  document.querySelectorAll("button[data-pick]").forEach(btn=>{
    btn.onclick = ()=>{
      const giftText = btn.getAttribute("data-pick");
      showGiftResult("pick", giftText);
    };
  });

  const btnCustomOK = document.querySelector("#btnCustomOK");
  if(btnCustomOK){
    btnCustomOK.onclick = ()=>{
      const v = (document.querySelector("#customGift")?.value || "").trim();
      if(!v){
        toast("å…ˆå†™ä¸€ä¸ªè‡ªå®šä¹‰ç¤¼ç‰©ï½");
        return;
      }
      showGiftResult("custom", v);
    };
  }
}
/************ ğŸ ç¤¼ç‰©æŠ½å¥–ä¸­å¿ƒç»“æŸ ************/

/** ========= å¼€å§‹æŒ‰é’® ========= **/
els.btnStart.onclick = ()=>{
  renderTasks();
  fireworkAt(window.innerWidth*0.5, window.innerHeight*0.25, true);
  toast("å¼€å§‹å•¦ï½å®Œæˆä»»åŠ¡è§£é”ç»ˆææƒŠå–œ ğŸ");
};

/** ========= åº”ç”¨æ˜µç§° ========= **/
els.btnApply.onclick = ()=>{
  applyNames();
  toast(`æ”¶åˆ°ï¼ä»Šæ™š ${state.you} åªåçˆ± ${state.gf} ğŸ’`);
};

/** ========= çº¢åŒ…é›¨ ========= **/
els.btnMoney.onclick = ()=> startMoneyRain(false);

function startMoneyRain(strong){
  if(state.moneyRaining && !strong) return;
  state.moneyRaining = true;
  const duration = strong ? 14000 : 9000;
  const endAt = Date.now() + duration;

  const spawn = ()=>{
    if(Date.now() > endAt){
      state.moneyRaining = false;
      return;
    }
    const d = document.createElement("div");
    d.className = "money";
    d.textContent = Math.random() < 0.6 ? "ğŸ§§" : (Math.random()<0.5 ? "ğŸª™" : "ğŸ’°");
    const left = Math.random() * 100;
    const size = 18 + Math.random()*18;
    d.style.left = left + "vw";
    d.style.fontSize = size + "px";
    d.style.animationDuration = (strong ? 4.5 : 6.5) + Math.random()*3 + "s";
    d.style.animationDelay = "0s";
    d.style.opacity = (strong ? .98 : .9);
    d.style.pointerEvents = "auto";
    d.style.cursor = "pointer";
// âœ… å…³é”®ï¼šç§»åŠ¨ç«¯å…ˆè§¦å‘ pointerdownï¼Œè¿™é‡Œå…ˆæ‹¦æˆªï¼Œé˜²æ­¢ window çš„ pointerdown æ”¾çƒŸèŠ±æŠ¢äº‹ä»¶
d.addEventListener("pointerdown", (e)=>{
  e.stopPropagation();
});

// ç‚¹ä¸­çº¢åŒ…è®¡æ•°ï¼ˆclick ä»ä¿ç•™ï¼Œå…¼å®¹æ¡Œé¢ï¼‰
d.addEventListener("click", (e)=>{
  e.stopPropagation();
  d.remove();
  state.moneyTapped++;
  confettiBurst(e.clientX, e.clientY);
  toast(`ğŸ§§ +1ï¼ˆå·²ç‚¹åˆ° ${state.moneyTapped} ä¸ªï¼‰`);
  const q = QUESTIONS.find(x=>x.type==="tapMoney");
  if(q && state.moneyTapped >= q.need){
    markDone(q.id);
  }
});

    d.addEventListener("click", (e)=>{
      e.stopPropagation();
      d.remove();
      state.moneyTapped++;
      confettiBurst(e.clientX, e.clientY);
      toast(`ğŸ§§ +1ï¼ˆå·²ç‚¹åˆ° ${state.moneyTapped} ä¸ªï¼‰`);

      const q = QUESTIONS.find(x=>x.type==="tapMoney");
      if(q && state.moneyTapped >= q.need){
        markDone(q.id);
      }
    });

    document.body.appendChild(d);
    setTimeout(()=> d.remove(), 12000);
    setTimeout(spawn, strong ? 120 : 210);
  };

  toast("çº¢åŒ…é›¨æ¥å’¯ï½å¿«ç‚¹çº¢åŒ…ğŸ§§");
  spawn();
}

/** ========= â€œéŸ³ä¹â€å°æ°›å›´ï¼ˆWebAudioï¼‰ ========= **/
let audioCtx = null;
let osc = null;

els.btnMusic.onclick = ()=>{
  if(!state.audioOn){
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = 528;
      gain.gain.value = 0.03;
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      state.audioOn = true;
      els.btnMusic.textContent = "ğŸ”‡ å…³é—­å°æ°›å›´";
      toast("å°æ°›å›´å¼€å¯ï¼ˆå¾ˆè½»å¾ˆè½»ï¼‰");
    }catch(e){
      toast("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘ã€‚");
    }
  }else{
    try{
      osc && osc.stop();
      audioCtx && audioCtx.close();
    }catch(e){}
    state.audioOn = false;
    els.btnMusic.textContent = "ğŸµ å¼€å¯å°æ°›å›´";
    toast("å·²å…³é—­");
  }
};

/** ========= æ—¶é’Ÿ ========= **/
function tickClock(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  els.nowStr.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
setInterval(tickClock, 1000);
tickClock();

/** ========= å®³ç¾æ¨¡å¼å½©è›‹ ========= **/
document.addEventListener("keydown",(e)=>{
  if(e.key.toLowerCase()==="h"){
    state.shyMode = !state.shyMode;
    document.body.style.filter = state.shyMode ? "saturate(1.2) brightness(1.05)" : "";
    toast(state.shyMode ? "ğŸ˜³ å®³ç¾æ¨¡å¼ ON" : "ğŸ™‚ å®³ç¾æ¨¡å¼ OFF");
  }
});

/** ========= canvas çƒŸèŠ± ========= **/
const canvas = document.querySelector("#fx");
const ctx = canvas.getContext("2d");
let W=0,H=0;

function resize(){
  W = canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
  H = canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
  canvas.style.width = window.innerWidth+"px";
  canvas.style.height = window.innerHeight+"px";
}
window.addEventListener("resize", resize);
resize();

const particles = [];
function fireworkAt(x,y, big){
  // ä»…åšè®¡æ•°ï¼ˆç¬¬å››å…³ç°åœ¨æ˜¯å†™æ„¿æœ›ï¼Œä¸é çƒŸèŠ±è¿‡å…³ï¼‰
  state.fireworksCount++;

  const cx = x * devicePixelRatio;
  const cy = y * devicePixelRatio;
  const count = big ? 90 : 60;
  for(let i=0;i<count;i++){
    const a = Math.random()*Math.PI*2;
    const sp = (big ? 3.2 : 2.2) + Math.random()*3.2;
    particles.push({
      x: cx, y: cy,
      vx: Math.cos(a)*sp*devicePixelRatio,
      vy: Math.sin(a)*sp*devicePixelRatio,
      life: 90 + Math.random()*30,
      r: 1.2 + Math.random()*1.4,
      hue: 280 + Math.random()*80,
      alpha: 1
    });
  }
}

function loop(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "rgba(0,0,0,.12)";
  ctx.fillRect(0,0,W,H);

  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.015*devicePixelRatio;
    p.vx *= 0.992;
    p.vy *= 0.992;
    p.life -= 1;
    p.alpha = clamp(p.life/110, 0, 1);

    ctx.beginPath();
    ctx.fillStyle = `hsla(${p.hue}, 100%, 75%, ${p.alpha})`;
    ctx.arc(p.x, p.y, p.r*devicePixelRatio, 0, Math.PI*2);
    ctx.fill();

    if(p.life<=0) particles.splice(i,1);
  }
  requestAnimationFrame(loop);
}
loop();

window.addEventListener("pointerdown", (e)=>{
  fireworkAt(e.clientX, e.clientY, false);
});

/** ========= åˆå§‹åŒ– ========= **/
function init(){
  els.gfName.value = DEFAULT_GF_NAME;
  els.yourName.value = DEFAULT_YOUR_NAME;
  applyNames();
  renderTasks();
}
init();
</script>
</body>
</html>
